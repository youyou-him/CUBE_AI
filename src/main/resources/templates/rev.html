<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ë¦¬ë·° ë¶„ì„ ê²°ê³¼ - Threshold & Confusion Matrix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial; background:#F7F8FC; }
        .sidebar-active { color:#2563EB; background:#EFF6FF; border-left:3px solid #2563EB; font-weight:600; }
        .card { background:#fff; border-radius:14px; box-shadow:0 2px 8px rgba(0,0,0,.06); max-height: 450px; }
        .graph-canvas { width:100%; height:300px !important; }
        #confMatrix { width:100%; height:300px !important; }
    </style>
</head>

<body class="text-gray-800">
<div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-white flex flex-col p-4 border-r">
        <div class="flex items-center space-x-3 px-2 py-4">
            <div class="p-2 bg-blue-600 rounded-lg">
                <i data-lucide="bar-chart-3" class="text-white w-6 h-6"></i>
            </div>
            <h1 class="text-xl font-bold text-gray-800">CRM Cube</h1>
        </div>

        <nav class="flex-1 mt-8 space-y-2">
            <p class="px-4 text-sm font-semibold text-gray-400 uppercase">Managements</p>
            <a href="/overview" class="flex items-center px-4 py-2.5 text-gray-500 hover:bg-gray-100 rounded-lg">
                <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Overview
            </a>
            <a href="/reviews" class="flex items-center px-4 py-2.5 text-gray-500 hover:bg-gray-100 rounded-lg">
                <i data-lucide="message-circle" class="w-5 h-5 mr-3"></i> Review Analysis
            </a>
            <a href="/rev" class="flex items-center px-4 py-2.5 text-gray-600 sidebar-active rounded-lg">
                <i data-lucide="activity" class="w-5 h-5 mr-3"></i> Threshold & Matrix
            </a>
            <a href="/recommendations" class="flex items-center px-4 py-2.5 text-gray-500 hover:bg-gray-100 rounded-lg">
                <i data-lucide="star" class="w-5 h-5 mr-3"></i> Recommendations
            </a>
            <a href="/clv-analysis" class="flex items-center px-4 py-2.5 text-gray-500 hover:bg-gray-100 rounded-lg">
                <i data-lucide="gem" class="w-5 h-5 mr-3"></i> CLV Analysis
            </a>
        </nav>

        <div class="pb-4">
            <div class="bg-blue-50 p-4 rounded-lg text-sm text-center">
                <p class="font-bold text-blue-800">High-Risk Customers</p>
                <p class="text-blue-600 my-1">There are <span class="font-bold">892</span> customers at risk of churn.</p>
                <button class="mt-2 w-full py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 text-xs">
                    Check Now
                </button>
            </div>
        </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white px-8 py-4 border-b shadow-sm">
            <h2 class="text-2xl font-bold">ë¦¬ë·° ê°ì • ë¶„ì„ ê²°ê³¼</h2>
            <p class="text-sm text-gray-500">
                Logistic Regression ê¸°ë°˜ ëª¨ë¸ì˜ Threshold ë³€í™”ì— ë”°ë¥¸ ì„±ëŠ¥ ì§€í‘œ ë° Confusion Matrixë¥¼ ì‹œê°í™”í•©ë‹ˆë‹¤.
            </p>
        </header>

        <div class="flex-1 p-6 grid grid-cols-2 gap-6 content-start overflow-y-auto">
            <!-- Precision / Recall / F1 ê·¸ë˜í”„ -->
            <section class="card p-5 flex flex-col items-center">
                <h3 class="text-base font-semibold text-gray-800 mb-3 text-center">
                    Precision, Recall, and F1-score vs Threshold
                </h3>
                <canvas id="thresholdChart" class="graph-canvas"></canvas>
                <p class="text-xs text-gray-500 mt-2 text-center">
                    Logistic Regression ëª¨ë¸ì˜ threshold ë³€í™”ì— ë”°ë¥¸ Precision, Recall, F1-score ì¶”ì´ì…ë‹ˆë‹¤.
                </p>
            </section>

            <!-- Confusion Matrix -->
            <section class="card p-5 flex flex-col items-center">
                <h3 class="text-base font-semibold text-gray-800 mb-3 text-center">
                    Confusion Matrix (Best Threshold)
                </h3>
                <div id="confMatrix"></div>
                <p class="text-xs text-gray-500 mt-2 text-center">
                    ìµœì  Thresholdì—ì„œì˜ ì‹¤ì œ ë¼ë²¨ê³¼ ì˜ˆì¸¡ ë¼ë²¨ì˜ ë¶„í¬ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
                </p>
            </section>
        </div>
    </main>
</div>

<!-- Script -->
<script>
    document.addEventListener("DOMContentLoaded", async () => {
      lucide.createIcons();

      // âœ… annotation í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
      const ChartAnnotation = window['chartjs-plugin-annotation'];
      Chart.register(ChartAnnotation);

      // âœ… 1ï¸âƒ£ Threshold Metrics JSON ë¶ˆëŸ¬ì˜¤ê¸°
      const tRes = await fetch("/data/threshold_metrics.json");
      const metrics = await tRes.json();

      const thresholds = metrics.thresholds.map(Number); // ìˆ«ì ë°°ì—´ë¡œ ë³€í™˜
      const precision = metrics.precision;
      const recall = metrics.recall;
      const f1 = metrics.f1;
      const bestThreshold = Number(metrics.best_threshold); // ğŸ”¥ ë°˜ë“œì‹œ ìˆ«ì ë³€í™˜

      const ctx = document.getElementById("thresholdChart");

      new Chart(ctx, {
        type: "line",
        data: {
          labels: thresholds,
          datasets: [
            { label: "Precision", data: precision, borderColor: "royalblue", borderWidth: 2, fill: false, tension: 0.3 },
            { label: "Recall", data: recall, borderColor: "darkorange", borderWidth: 2, fill: false, tension: 0.3 },
            { label: "F1-score", data: f1, borderColor: "green", borderWidth: 2, fill: false, tension: 0.3 },
          ],
        },
        options: {
          maintainAspectRatio: true,
          responsive: true,
          scales: {
            x: {
              type: "linear", // âœ… í•µì‹¬: ìˆ«ìí˜• xì¶•
              title: { display: true, text: "Threshold" },
              min: 0,
              max: 1,
            },
            y: {
              title: { display: true, text: "Score" },
              min: 0,
              max: 1.05,
            },
          },
          plugins: {
            legend: { position: "bottom" },
            annotation: {
              annotations: {
                bestLine: {
                  type: "line",
                  xMin: bestThreshold,
                  xMax: bestThreshold,
                  borderColor: "red",
                  borderDash: [6, 6],
                  borderWidth: 2,
                  label: {
                    display: true,
                    content: `Best Threshold = ${bestThreshold}`,
                    position: "end",
                    color: "red",
                    font: { size: 11 },
                  },
                },
              },
            },
          },
          elements: { point: { radius: 0 } },
        },
        plugins: [ChartAnnotation],
      });

      // âœ… 2ï¸âƒ£ Confusion Matrix JSON ë¶ˆëŸ¬ì˜¤ê¸°
      const cRes = await fetch("/data/confusion_matrix.json");
      const cmData = await cRes.json();

      const Z = cmData.matrix;
      const xLabels = cmData.labels;
      const yLabels = cmData.labels;

      const dataConf = [
        {
          type: "heatmap",
          z: Z,
          x: xLabels,
          y: yLabels,
          colorscale: "Blues",
          zmin: 0,
          zmax: Math.max(...Z.flat()),
          colorbar: { title: "Count", thickness: 14, len: 0.9 },
          xgap: 2,
          ygap: 2,
        },
      ];

      const annotations = [];
      for (let i = 0; i < yLabels.length; i++) {
        for (let j = 0; j < xLabels.length; j++) {
          annotations.push({
            x: xLabels[j],
            y: yLabels[i],
            text: String(Z[i][j]),
            font: { color: "#1e3a8a", size: 13 },
            showarrow: false,
          });
        }
      }

      const layoutConf = {
        margin: { l: 70, r: 60, t: 10, b: 50 },
        annotations: annotations,
        yaxis: { autorange: "reversed", title: "True Label" },
        xaxis: { title: "Predicted Label" },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
      };

      Plotly.newPlot("confMatrix", dataConf, layoutConf, { displayModeBar: false, responsive: true });
    });
</script>
</body>
</html>
